<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Running &#8212; Stitch  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Efficient Queries" href="EfficientQueries.html" />
    <link rel="prev" title="Query Execution" href="QueryExecution.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="running">
<span id="id1"></span><h1>Running<a class="headerlink" href="#running" title="Link to this heading">¶</a></h1>
<p>Stitches must be run to execute the computation and get the result.
Running a Stitch returns a Future which will complete with the final
value of the Stitch. Exceptions that occur during the running of a
Stitch are encapsulated in the Stitch and can be handled in the same
way that Futures handle exceptions.</p>
<p><a class="reference internal" href="TwitterLocals.html#twitter-locals"><span class="std std-ref">Twitter Locals are also available when running a Stitch</span></a>.</p>
<section id="thread-safety">
<span id="id2"></span><h2>Thread-safety<a class="headerlink" href="#thread-safety" title="Link to this heading">¶</a></h2>
<p>During execution of a Stitch query, multiple underlying RPC calls may
run in parallel. When an underlying call returns, query simplification
(including calling callbacks) runs in a single thread with a lock on
the execution state. Each phase of simplification may occur in a
different thread (e.g. because a different Finagle thread handled the
RPC response).</p>
<p>Because the execution state is synchronized, it’s safe to modify local
state (e.g. to accumulate a result into a buffer) inside a query
without extra locking. Moreover the results of one phase of
simplification are visible to other phases even if they happen in
different threads.</p>
<p>This guarantee applies only within a single query execution (i.e. a
call to <cite>Stitch.run</cite>); it’s not safe to operate (without extra
locking) on state which is shared between multiple executions of the
same query or different queries.</p>
<p><strong>Caveat</strong>: you probably don’t want to use stateful operations in
most cases.</p>
</section>
</section>
<section id="never-re-runnable">
<span id="id3"></span><h1>Never Re-Runnable<a class="headerlink" href="#never-re-runnable" title="Link to this heading">¶</a></h1>
<p>It’s not safe to re-run a Stitch query (besides the below exceptions).
While in practice, there may be occasions where no issues are seen,
it is inherently unsafe to rerun Stitches. The behavior is undefined
and should not be relied upon. <cite>Stitch.const</cite> (<cite>Stitch.value</cite> or <cite>Stitch.exception</cite>)
and <cite>Stitch.synchronizedRef</cite> are exceptions to this rule and are safe to re-run
but other Stitches are not considered safe to re-run.</p>
<p>All of the following are examples of rerunning:</p>
<ul>
<li><p>Directly rerunning</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">s0</span><span class="p">:</span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Rerunning a Stitch which contains an already run Stitch</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">s0</span><span class="p">:</span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span>
<span class="kd">val</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="p">.</span><span class="n">ensure</span><span class="p">(</span><span class="n">sideEffect</span><span class="p">)</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="c1">// unsafe since it will rerun s0</span>
</pre></div>
</div>
</li>
<li><p>FlatMapping on an already run Stitch</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">s0</span><span class="p">:</span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span>
<span class="kd">val</span><span class="w"> </span><span class="n">s1</span><span class="p">:</span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span>
<span class="kd">val</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="c1">// or Stitch.join(s0, s1)</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="w"> </span><span class="c1">// unsafe since it will rerun s1</span>
</pre></div>
</div>
</li>
</ul>
<p>This is not an exhaustive list but it gives you an idea.
The key thing to remember is that no part of a Stitch should ever be passed
into more than one call to <cite>Stitch.run</cite>. However, it is safe to reuse a Stitch
as long as it is within the same <cite>Stitch.run</cite> call. This is covered in more
detail in <a class="reference internal" href="BasicExamples.html#refs"><span class="std std-ref">the section on Stitch.ref</span></a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nc">Stitch</span><span class="p">.</span><span class="nc">Unit</span><span class="p">.</span><span class="n">onSuccess</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;this safely runs twice&quot;</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="p">.</span><span class="n">before</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
</pre></div>
</div>
<p>This is safe since <cite>Stitch.run</cite> can correctly handle coming
across the same Stitch multiple times in the execution graph.</p>
<p>Why is re-running a Stitch unsafe?
Stitches have internal mutable state, that state is changed during running
without any locking or synchronization. This means that if a Stitch is run
concurrently you can experience unexpected behavior like missing data, code
that never executes, or other unwanted behavior. The 2 exceptions to this rule
are <cite>Stitch.const</cite> (<cite>Stitch.value</cite> or <cite>Stitch.exception</cite>) which is safe to re-run
since it’s a constant and doesn’t have mutable state and <cite>Stitch.synchronizedRefs</cite>
which are are safe to re-run but have the additional cost of extra
synchronization overhead. Since the structure of a Stitch (such as whether
it’s a <cite>Const</cite> or <cite>SynchronizedRef</cite>) is opaque to the user (due to being private
classes) it’s not possible to pattern match or otherwise assume an arbitrary
<cite>Stitch[T]</cite> is in one of these forms unless it was explicitly put into one of
these forms.</p>
<p>Next <a class="reference internal" href="EfficientQueries.html#efficient-queries"><span class="std std-ref">Efficient Queries</span></a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Stitch</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchVsFuture.html">Stitch vs Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhyUseStitch.html">Why use Stitch?</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicExamples.html">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="FailureHandling.html">Failure handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="ServiceAdapters.html">Service Adapters</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchConcepts.html">Stitch Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="QueryExecution.html">Query Execution</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#thread-safety">Thread-safety</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#never-re-runnable">Never Re-Runnable</a></li>
<li class="toctree-l1"><a class="reference internal" href="EfficientQueries.html">Efficient Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchCache.html">StitchCache</a></li>
<li class="toctree-l1"><a class="reference internal" href="TwitterLocals.html">Twitter Locals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Recursion.html">Recursion</a></li>
<li class="toctree-l1"><a class="reference internal" href="Advanced.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arrows.html">Arrows</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="QueryExecution.html" title="previous chapter">Query Execution</a></li>
      <li>Next: <a href="EfficientQueries.html" title="next chapter">Efficient Queries</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/Running.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>