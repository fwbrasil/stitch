<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Efficient Queries &#8212; Stitch  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="StitchCache" href="StitchCache.html" />
    <link rel="prev" title="Running" href="Running.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="efficient-queries">
<span id="id1"></span><h1>Efficient Queries<a class="headerlink" href="#efficient-queries" title="Link to this heading">¶</a></h1>
<p>The basic rule for writing efficient queries is to minimize
dependencies. Independent queries can be executed concurrently
(reducing latency), and independent queries to the same underlying
service can be batched together into a single RPC call.</p>
<p>Like Futures, Stitch queries may be composed in two ways:</p>
<ul class="simple">
<li><p>dependent composition, where one query depends on the result of another.
Such as flatMap, rescue, and for comprehensions.</p></li>
<li><p>concurrent composition, where queries have no interdependencies.
Such as join, collect, and traverse</p></li>
</ul>
<p>As with Futures, concurrently composed Stitch queries may be executed
concurrently (e.g. concurrent calls to underlying services); moreover,
the execution of a Stitch query can “see” all concurrent queries together,
so they may be batched together and deduplicated.</p>
<p>Concurrent composition is preferable wherever possible
because it offers more scope for optimization.</p>
<p>False data dependencies can prevent a Stitch query from achieving
optimal batching performance. False data dependencies occur when a
later part of a Stitch query falsely depends on an earlier part.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">fooStitch</span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">  </span><span class="n">barStitch</span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="n">query</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>the call to <cite>query(foo)</cite> depends on <cite>barStitch</cite> (because it’s
inside the <cite>flatMap</cite> of <cite>barStitch</cite>) but doesn’t use the result
<cite>bar</cite>. So the execution of <cite>query(foo)</cite> is unnecessarily delayed
until <cite>barStitch</cite> completes, increasing overall latency and possibly
missing opportunities for batching (Futures have the same pitfall).</p>
<section id="avoiding-false-dependencies">
<span id="id2"></span><h2>Avoiding false dependencies<a class="headerlink" href="#avoiding-false-dependencies" title="Link to this heading">¶</a></h2>
<p>You can rewrite the query above with <cite>Stitch.join</cite> to avoid the
false dependency:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">Stitch</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fooStitch</span><span class="p">,</span><span class="w"> </span><span class="n">barStitch</span><span class="p">)</span><span class="w"> </span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">  </span><span class="n">query</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The arguments to <cite>Stitch.join</cite> are independent, so in general
sub-queries to the same underlying service will be batched together,
e.g.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">Stitch</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">tweetService</span><span class="p">.</span><span class="n">getTweet</span><span class="p">(</span><span class="n">id1</span><span class="p">),</span><span class="w"> </span><span class="n">tweetService</span><span class="p">.</span><span class="n">getTweet</span><span class="p">(</span><span class="n">id2</span><span class="p">))</span>
</pre></div>
</div>
<p>The same goes for the sub-queries in <cite>Stitch.traverse</cite> and
<cite>Stitch.collect</cite>, e.g.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">Stitch</span><span class="p">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tweetService</span><span class="p">.</span><span class="n">getTweet</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>However the details of batching are service-specific, so even independent
queries may not always be batched. Consult the documentation for the
specific <a class="reference internal" href="ServiceAdapters.html#service-adapters"><span class="std std-ref">Service Adapter</span></a> to be sure.</p>
<section id="for-expressions">
<span id="id3"></span><h3>For-expressions<a class="headerlink" href="#for-expressions" title="Link to this heading">¶</a></h3>
<p>Watch out especially for false dependencies in <cite>for</cite>-expressions:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">foo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fooStitch</span>
<span class="w">  </span><span class="n">bar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">barStitch</span>
<span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">query</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>which are equivalent to nested <cite>flatMap</cite> s but don’t indicate the
nesting visually. You can rewrite without the false dependency as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Stitch</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fooStitch</span><span class="p">,</span><span class="w"> </span><span class="n">barStitch</span><span class="p">)</span>
<span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">query</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>Next <a class="reference internal" href="StitchCache.html#stitchcache"><span class="std std-ref">StitchCache</span></a></p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Stitch</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchVsFuture.html">Stitch vs Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhyUseStitch.html">Why use Stitch?</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicExamples.html">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="FailureHandling.html">Failure handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="ServiceAdapters.html">Service Adapters</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchConcepts.html">Stitch Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="QueryExecution.html">Query Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="Running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="Running.html#never-re-runnable">Never Re-Runnable</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Efficient Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#avoiding-false-dependencies">Avoiding false dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#for-expressions">For-expressions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="StitchCache.html">StitchCache</a></li>
<li class="toctree-l1"><a class="reference internal" href="TwitterLocals.html">Twitter Locals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Recursion.html">Recursion</a></li>
<li class="toctree-l1"><a class="reference internal" href="Advanced.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arrows.html">Arrows</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Running.html" title="previous chapter">Running</a></li>
      <li>Next: <a href="StitchCache.html" title="next chapter">StitchCache</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/EfficientQueries.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>