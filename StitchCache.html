<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>StitchCache &#8212; Stitch  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Twitter Locals" href="TwitterLocals.html" />
    <link rel="prev" title="Efficient Queries" href="EfficientQueries.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="stitchcache">
<span id="id1"></span><h1>StitchCache<a class="headerlink" href="#stitchcache" title="Link to this heading">¶</a></h1>
<p>StitchCache is a cache for storing Stitches.
It allows caching a Stitch query and using the result multiple times.
StitchCache provides a basic caching API, similar to FutureCache.
However, since Stitches are different from Futures, StitchCache is also different from FutureCache.</p>
<p>StitchCache has a <cite>get</cite>, <cite>getOrElseUpdate</cite>, <cite>set</cite>, <cite>evict</cite>, and <cite>size</cite> methods. <cite>get</cite>,
<cite>getOrElseUpdate</cite>, and <cite>set</cite> all return Stitches, the returned Stitch is what is stored in the cache
and may be used for eviction (except for <cite>ValueCache</cite>). Unlike FutureCache, where the passed in Future
can be used to evict, only the Stitch returned by one of these methods can be used to evict.</p>
<p>Stitches passed into a StitchCache become owned by the cache, and Stitches returned from it are owned by the caller.
This means only the owner of the Stitch may run the Stitch, so you must never run the Stitch that is passed into
the cache (not before it’s passed in, not after it’s passed in, never! see <a class="reference internal" href="Running.html#never-re-runnable"><span class="std std-ref">Never Re-Runnable</span></a>)
since it is owned by the cache. Instead, run the Stitch returned by <cite>get</cite>, <cite>getOrElseUpdate</cite>, or <cite>set</cite>.
The Stitch returned by the cache is safe to run since it’s owned by the caller.
However, the general rules of Stitches still apply, you must <a class="reference internal" href="Running.html#never-re-runnable"><span class="std std-ref">never rerun</span></a>
Stitches returned by the cache, and instead must query the cache for a new Stitch each time.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AtomicInteger</span><span class="p">()</span>

<span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SeqGroup</span><span class="p">[</span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]{</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Int</span><span class="p">]):</span><span class="w"> </span><span class="nc">Future</span><span class="p">[</span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Try</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">keys</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">())</span>
<span class="w">  </span><span class="nc">Future</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Return</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="p">}}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">cache</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">StitchCache</span><span class="p">.</span><span class="n">fromMap</span><span class="p">[</span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">](</span>
<span class="w">        </span><span class="n">arg</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Stitch</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">),</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">ConcurrentHashMap</span><span class="p">())</span>

<span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">cache</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="c1">// result: 1</span>
<span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">cache</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="c1">// result: 1</span>
<span class="n">count</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="c1">// result: 1</span>
</pre></div>
</div>
<p>The first time this is called with <cite>0</cite>, it will make the call to <cite>g</cite>.
This would be as if there is no cache in place. However, for the second one,
it would access the cached value and it wouldn’t need to call <cite>g</cite> at all.</p>
<p>StitchCache also has the ability to deduplicate requests across calls to Stitch.run.
The below example illustrates this by concurrently calling the same key from the
cache in multiple <cite>Stitch.run</cite> calls but the underlying request is only ever sent once.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">timer</span><span class="p">:</span><span class="w"> </span><span class="nc">Timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">JavaTimer</span><span class="p">()</span>

<span class="kd">val</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AtomicInteger</span><span class="p">()</span>

<span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SeqGroup</span><span class="p">[</span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]{</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Int</span><span class="p">]):</span><span class="w"> </span><span class="nc">Future</span><span class="p">[</span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Try</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">keys</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">())</span>
<span class="w">  </span><span class="c1">// sleep to simulate an RPC, though this isn&#39;t really necessary</span>
<span class="w">  </span><span class="nc">Future</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="nc">Duration</span><span class="p">.</span><span class="n">fromMilliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">before</span><span class="p">(</span><span class="nc">Future</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Return</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">}}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">cache</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Stitch</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">StitchCache</span><span class="p">.</span><span class="n">fromMap</span><span class="p">[</span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">](</span>
<span class="w">        </span><span class="n">arg</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Stitch</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">),</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">ConcurrentHashMap</span><span class="p">())</span>

<span class="kd">val</span><span class="w"> </span><span class="n">concurrentlyRunning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">  </span><span class="nc">FuturePool</span><span class="p">.</span><span class="n">unboundedPool</span><span class="p">(</span><span class="nc">Stitch</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">cache</span><span class="p">(</span><span class="mi">0</span><span class="p">))).</span><span class="n">flatten</span><span class="p">)</span>

<span class="c1">// paste the below in separately due to an issue with the repl</span>

<span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span>
<span class="w">  </span><span class="nc">Future</span><span class="p">.</span><span class="n">collect</span><span class="p">(</span><span class="n">concurrentlyRunning</span><span class="p">)</span><span class="w"> </span><span class="c1">// result: Seq(1, 1, 1, ...)</span>
<span class="p">)</span>
<span class="n">count</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="c1">// result: 1</span>
</pre></div>
</div>
<p>Next <a class="reference internal" href="TwitterLocals.html#twitter-locals"><span class="std std-ref">Twitter Locals</span></a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Stitch</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchVsFuture.html">Stitch vs Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhyUseStitch.html">Why use Stitch?</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicExamples.html">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="FailureHandling.html">Failure handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="ServiceAdapters.html">Service Adapters</a></li>
<li class="toctree-l1"><a class="reference internal" href="StitchConcepts.html">Stitch Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="QueryExecution.html">Query Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="Running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="Running.html#never-re-runnable">Never Re-Runnable</a></li>
<li class="toctree-l1"><a class="reference internal" href="EfficientQueries.html">Efficient Queries</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">StitchCache</a></li>
<li class="toctree-l1"><a class="reference internal" href="TwitterLocals.html">Twitter Locals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Recursion.html">Recursion</a></li>
<li class="toctree-l1"><a class="reference internal" href="Advanced.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arrows.html">Arrows</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="EfficientQueries.html" title="previous chapter">Efficient Queries</a></li>
      <li>Next: <a href="TwitterLocals.html" title="next chapter">Twitter Locals</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/StitchCache.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>